<html lang="en">
<head>
    <title>EuDGC Parser Sample</title>
    <meta charset="utf-8" />
    <style>

h1 {
    margin: 2px;
}

body {
    display: flex;
    flex-direction: column;
    margin: 2px;
}

#info {
    font-family: 'Courier New', Courier, monospace;
    background-color: #eeeeee;
    padding: 0.5rem;
    margin-top: 1rem;
    font-size: 11px;
    overflow: auto;
}

    </style>
</head>

<body>
    <h1>EuDGC Parser Demo</h1>
    <o>Scan your EuDGC Covid Vaccination QR-Code</h1>
    <div>
        <canvas id="canvas" style="width: 480px; height: 360px;"></canvas>
    </div>
    <pre id="info">

    </div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="eudgc.js"></script>
<script>

const canvas = document.getElementById("canvas")
const ctx = canvas.getContext("2d")

const video = document.createElement("video")
video.setAttribute("width", 400)
video.setAttribute("height", 300)
navigator.mediaDevices.getUserMedia({ 
    video: { facingMode: "environment" } 
}).then((stream) => {
    video.srcObject = stream
    video.setAttribute("playsinline", true) // for safari
    video.play()
    requestAnimationFrame(frame)
})


const frame = async () => {
    requestAnimationFrame(frame)

    let payload = ""  // the qrcode will end here
    if (video.readyState != video.HAVE_ENOUGH_DATA) {
        return
    }
    canvas.height = video.videoHeight
    canvas.width = video.videoWidth 
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height)
    const size = Math.min(canvas.width, canvas.height) / 1.6
    const x = .5 * (canvas.width - size)
    const y = .5 * (canvas.height - size)
    const imageData = ctx.getImageData(x, y, size, size)
    const code = jsQR(
        imageData.data,
        imageData.width,
        imageData.height, {
            inversionAttempts: "dontInvert",
    })
    if (code && code.data && payload != code.data) {
        payload = code.data

        // make a result structure
        let result = {}
        result.qrcode = payload

        // try to parse the EuDGC Vaccination Qr-Code
        try {
            const certificate = await EuDgc_parse(payload?.trim())
            result.eudgc = certificate
        } catch (error) {
            console.error("no eudgc certificate found: " + error)
            result.eudgc = "No Valid Certificate"
        }

        // format into a buffer and print out the buffer        
        let buffer = JSON.stringify(result, null, 4)
        document.getElementById("info").textContent = buffer
    }
}

    </script>

</html>